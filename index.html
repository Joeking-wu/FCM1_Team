<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Google Sheet è®€å– / å¯«å…¥ Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Tab æ¨£å¼ */
        .tab-container {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 5px;
            margin-top: -20px;
            gap: 10px; /* æ–°å¢æ­¤è¡Œä¾†è¨­å®šæŒ‰éˆ•é–“è· */
        }

        .tab-button {
            background-color: #cccbc2;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

            .tab-button:hover {
                background-color: #a6a6a6;
            }

            .tab-button.active {
                background-color: #007bff;
                color: white;
                border-bottom: 3px solid #007bff;
            }

        .tab-content {
            display: none;
            padding: 10px;
            border-top: none;
            border: 2px solid #ff6600;
        }

        /* å…¶ä»–é€šç”¨æ¨£å¼ */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f9f9f9;
        }

        h2, h3 {
            margin-top: 0;
            color: #333;
        }

        .separator {
            width: 100%; /* åˆ†éš”ç·šå¯¬åº¦ */
            height: 1px; /* åˆ†éš”ç·šé«˜åº¦ï¼Œé€šå¸¸æ˜¯1px */
            border-top: 1px solid #ccc; /* è¨­ç½®é ‚éƒ¨é‚Šæ¡†ï¼Œé¡è‰²ç‚ºç°è‰² */
            margin-top: 20px; /* èˆ‡ä¸Šæ–¹å…§å®¹çš„è·é›¢ */
            margin-bottom: 20px; /* èˆ‡ä¸‹æ–¹å…§å®¹çš„è·é›¢ */
        }

        /* è¼¸å…¥å€å¡Š */
        #input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

            #input-container input[type="text"] {
                flex: 1 1 220px;
                height: 40px;
                font-size: 16px;
                padding: 5px 10px;
                border: 1px solid #aaa;
                border-radius: 6px;
                box-sizing: border-box;
            }

        .date-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1 1 220px;
        }

        .btn-date {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 14px;
            cursor: pointer;
            height: 40px;
        }

            .btn-date:hover {
                background-color: #1e7e34;
            }

        /* ä¸‹æ‹‰é¸å–® */
        select {
            height: 40px;
            font-size: 16px;
            padding: 5px;
            border-radius: 6px;
            border: 1px solid #aaa;
            margin-top: 5px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            margin-top: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

            button:hover {
                background-color: #0056b3;
            }

        /* è¡¨æ ¼æ¨£å¼ */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: left;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        tr:nth-child(even) td {
            background-color: #fafafa;
        }

        /* æ–°å¢çš„åˆ†é æ¨£å¼ */
        #pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

            #pagination-container button {
                background-color: #6c757d;
                padding: 8px 15px;
                font-size: 14px;
            }

                #pagination-container button:hover:not(:disabled) {
                    background-color: #5a6268;
                }

                #pagination-container button:disabled {
                    cursor: not-allowed;
                    opacity: 0.5;
                }

            #pagination-container span {
                font-size: 16px;
                color: #555;
            }
    </style>
</head>
<body>
    <div class="tab-container">
        <button class="tab-button" onclick="openTab(event, 'tab-login')">ç™»å…¥è¨­å®š</button>
        <button class="tab-button" onclick="openTab(event, 'tab-read')">è®€å–è³‡æ–™</button>
        <button class="tab-button" onclick="openTab(event, 'tab-write')">æ–°å¢è³‡æ–™</button>
    </div>

    <!-- Tab Content: ç™»å…¥è¨­å®š -->
    <div id="tab-login" class="tab-content">
        <h3>ç™»å…¥è¨­å®š</h3>
        <p>è«‹è¼¸å…¥æ‚¨çš„ Google App Script URLã€è©¦ç®—è¡¨ç¶²å€å’Œå·¥ä½œè¡¨åç¨±ã€‚</p>
        <label>Google App Scriptï¼š</label>
        <input id="appUrl" type="text"><br /><br />
        <label>è©¦ç®—è¡¨ç¶²å€ï¼š</label>
        <input id="sheetsUrl" type="text"><br /><br />
        <label>å·¥ä½œè¡¨åç¨±ï¼š</label>
        <input id="sheetName" type="text" value="Sheet1"><br /><br />
    </div>

    <!-- Tab Content: è®€å–è³‡æ–™ -->
    <div id="tab-read" class="tab-content">
        <h3>è®€å–è³‡æ–™</h3>
        <button onclick="loadData()">ğŸ“– è®€å–è³‡æ–™</button>
    </div>
    <table id="data-table"></table>
    <div id="pagination-container"></div>

    <!-- Tab Content: æ–°å¢è³‡æ–™ -->
    <div id="tab-write" class="tab-content">
        <h3>æ–°å¢è³‡æ–™</h3>
        <div id="input-container">
            <input type="text" placeholder="TRACK NO.">
            <input type="text" placeholder="åº—è™Ÿ">

            <div class="date-wrapper">
                <input type="text" id="errorDate" placeholder="ç•°å¸¸ç™¼ç”Ÿæ—¥æœŸ (YYMMDD)">
                <button type="button" class="btn-date">ğŸ“…</button>
            </div>

            <select id="category1"></select>
            <select id="category2"></select>
            <select id="category3"></select>
            <select id="category4"></select>
        </div>
        <select id="mode">
            <option value="top">æ’å…¥æœ€ä¸Šé¢</option>
            <option value="bottom">æ’å…¥æœ€å¾Œ</option>
        </select>
        <button >âœï¸ å¯«å…¥</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // åœ¨é€™è£¡ï¼Œåªç²å– DOM å…ƒç´ 
        const appUrlInput = document.getElementById('appUrl');
        const sheetsUrlInput = document.getElementById('sheetsUrl');
        const sheetNameInput = document.getElementById('sheetName');

        const category1Select = document.getElementById('category1');
        const category2Select = document.getElementById('category2');
        const category3Select = document.getElementById('category3');
        const category4Select = document.getElementById('category4');

        // å…¨åŸŸè®Šæ•¸ä¾†è¿½è¹¤åˆ†é ç‹€æ…‹
        let currentPage = 1;
        let totalPages = 1;
        const ITEMS_PER_PAGE = 50; // æ¯é é¡¯ç¤ºçš„ç­†æ•¸

        // å„²å­˜åˆ†é¡è³‡æ–™çš„ç‰©ä»¶ï¼Œå¯æ“´å……
        const categoriesData = {
            '01_Power Box (FCM-A02) é›»æºç®±': {
                'åˆ†é¡2A': {
                    'åˆ†é¡3A': ['åˆ†é¡4A', 'åˆ†é¡4B'],
                    'åˆ†é¡3B': ['åˆ†é¡4C', 'åˆ†é¡4D']
                },
                'åˆ†é¡2B': {
                    'åˆ†é¡3C': ['åˆ†é¡4E', 'åˆ†é¡4F'],
                    'åˆ†é¡3D': ['åˆ†é¡4G', 'åˆ†é¡4H']
                }
            },
            '02_Machine Head (Main Body)(FCM-A01) æ©Ÿé ­': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            },
            '03_Trash Bin(FCM-A10) åƒåœ¾ç­’': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            },
            '04_Auxiliary Devices (Compressor, Air Tank, Vacuum, etc.) ç©ºå£“æ©Ÿã€å„²æ°£æ¡¶ã€å¸å¡µå™¨': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            },
            '05_Human-machine Interface (HMI) (FCM-A03) äººæ©Ÿ': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            },
            '06_Label Printer(FCM-A12) æ¨™ç±¤æ©Ÿ': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            },
            '07_Tray(FCM-A11)': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            },
            '08_Air Control Panel ç©ºå£“æ§åˆ¶é¢ç›¤': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            },
            '09_å…¶ä»–': {
                'åˆ†é¡2C': {
                    'åˆ†é¡3E': ['åˆ†é¡4I', 'åˆ†é¡4J'],
                    'åˆ†é¡3F': ['åˆ†é¡4K', 'åˆ†é¡4L']
                },
                'åˆ†é¡2D': {
                    'åˆ†é¡3G': ['åˆ†é¡4M', 'åˆ†é¡4N'],
                    'åˆ†é¡3H': ['åˆ†é¡4O', 'åˆ†é¡4P']
                }
            }
        };

        document.addEventListener("DOMContentLoaded", function () {
            // é è¨­é–‹å•Ÿç¬¬ä¸€å€‹é ç±¤
            document.querySelector('.tab-button').click();

            const errorDateInput = document.getElementById("errorDate");
            const dateButton = document.querySelector(".btn-date");

            // åˆå§‹åŒ– Flatpickrï¼Œä¸¦å°‡å…¶ç¶å®šåˆ°æ–‡å­—è¼¸å…¥æ¡†
            const fp = flatpickr(errorDateInput, {
                dateFormat: "ymd", // è¨­å®šæ—¥æœŸæ ¼å¼ç‚º YYMMDD
            });

            // ç‚ºæŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨ï¼Œç•¶é»æ“Šæ™‚é–‹å•Ÿæ—¥æœŸé¸æ“‡å™¨
            dateButton.addEventListener("click", function () {
                fp.open();
            });

            // åˆå§‹åŒ–é€£å‹•ä¸‹æ‹‰é¸å–®
            initDropdowns();
        });

        function openTab(evt, tabName) {
            // å®£å‘Šæ‰€æœ‰è®Šæ•¸
            let i, tabcontent, tabbuttons;

            // å–å¾—æ‰€æœ‰ class ç‚º "tab-content" çš„å…ƒç´ ä¸¦éš±è—
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // å–å¾—æ‰€æœ‰ class ç‚º "tab-button" çš„å…ƒç´ ä¸¦ç§»é™¤ "active" class
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }

            // é¡¯ç¤ºç•¶å‰é ç±¤ï¼Œä¸¦ç‚ºé»æ“Šçš„æŒ‰éˆ•æ·»åŠ  "active" class
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        async function loadData(page = 1) {
            // åœ¨å‡½å¼è¢«å‘¼å«æ™‚ï¼Œæ‰å»è®€å–è¼¸å…¥æ¡†çš„æœ€æ–°å€¼
            const appUrl = appUrlInput.value;
            const sheetsUrl = sheetsUrlInput.value;
            const sheetName = sheetNameInput.value;

            const GAS_URL = `https://script.google.com/macros/s/${appUrl}/exec`;
            const SHEET_URL = `https://docs.google.com/spreadsheets/d/${sheetsUrl}/edit?gid=0`;

            const url = `${GAS_URL}?action=read&url=${encodeURIComponent(SHEET_URL)}&name=${encodeURIComponent(sheetName)}&page=${page}&limit=${ITEMS_PER_PAGE}`;

            try {
                const res = await fetch(url);
                const json = await res.json();

                if (json.status === "success") {
                    renderTable(json.values);
                    totalPages = json.totalPages;
                    currentPage = page;
                    renderPagination();
                } else {
                    // æ›¿æ› alert ç‚ºè‡ªå®šç¾©è¨Šæ¯
                    const message = "è®€å–å¤±æ•—ï¼š" + json.message;
                    console.error(message);
                }
            } catch (err) {
                // æ›¿æ› alert ç‚ºè‡ªå®šç¾©è¨Šæ¯
                const message = "è®€å–å¤±æ•—ï¼š" + err.message;
                console.error(message);
            }
        }

        async function writeData() {
            const appUrl = appUrlInput.value;
            const sheetsUrl = sheetsUrlInput.value;
            const sheetName = sheetNameInput.value;

            const GAS_URL = `https://script.google.com/macros/s/${appUrl}/exec`;
            const SHEET_URL = `https://docs.google.com/spreadsheets/d/${sheetsUrl}/edit?gid=0`;

            const inputs = document.querySelectorAll("#input-container input[type='text'], #input-container select");
            const values = Array.from(inputs).map(input => input.value.trim());

            if (values.every(v => v === "")) {
                // æ›¿æ› alert ç‚ºè‡ªå®šç¾©è¨Šæ¯
                console.warn("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹å€¼ï¼");
                return;
            }

            const mode = document.getElementById("mode").value;

            const params = {
                mode: 'write',
                url: SHEET_URL,
                name: sheetName,
                insertAt: mode,
                values: JSON.stringify(values)
            };

            const url = `${GAS_URL}?${new URLSearchParams(params)}`;

            try {
                const res = await fetch(url);
                const json = await res.json();

                if (json.status === "success") {
                    // æ›¿æ› alert ç‚ºè‡ªå®šç¾©è¨Šæ¯
                    console.log("âœ… å¯«å…¥æˆåŠŸï¼æ’å…¥åœ¨ç¬¬ " + json.row + " åˆ—");
                    clearInputs();
                    // å¯«å…¥å¾Œé‡æ–°è®€å–ç•¶å‰é è³‡æ–™
                    loadData(currentPage);
                } else {
                    // æ›¿æ› alert ç‚ºè‡ªå®šç¾©è¨Šæ¯
                    const message = "å¯«å…¥å¤±æ•—ï¼š" + json.message;
                    console.error(message);
                }
            } catch (err) {
                // æ›¿æ› alert ç‚ºè‡ªå®šç¾©è¨Šæ¯
                const message = "å¯«å…¥å¤±æ•—ï¼š" + err.message;
                console.error(message);
            }
        }

        function clearInputs() {
            document.querySelectorAll("#input-container input[type='text'], #input-container select").forEach(input => input.value = "");
            initDropdowns(); // æ¸…ç©ºè¼¸å…¥å¾Œé‡æ–°åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
        }

        function renderTable(values) {
            const table = document.getElementById("data-table");
            table.innerHTML = "";
            values.forEach((row, i) => {
                const tr = document.createElement("tr");
                row.forEach(cell => {
                    const td = document.createElement(i === 0 ? "th" : "td");
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

        // æ¸²æŸ“åˆ†é æŒ‰éˆ•çš„å‡½å¼
        function renderPagination() {
            const paginationContainer = document.getElementById("pagination-container");
            paginationContainer.innerHTML = '';

            // ä¸Šä¸€é æŒ‰éˆ•
            const prevBtn = document.createElement("button");
            prevBtn.textContent = "ä¸Šä¸€é ";
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => loadData(currentPage - 1);
            paginationContainer.appendChild(prevBtn);

            // é ç¢¼è³‡è¨Š
            const pageInfo = document.createElement("span");
            pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
            paginationContainer.appendChild(pageInfo);

            // ä¸‹ä¸€é æŒ‰éˆ•
            const nextBtn = document.createElement("button");
            nextBtn.textContent = "ä¸‹ä¸€é ";
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => loadData(currentPage + 1);
            paginationContainer.appendChild(nextBtn);
        }

        // è¼”åŠ©å‡½å¼ï¼šå¡«å……ä¸‹æ‹‰é¸å–®
        function populateDropdown(selectElement, options, placeholder) {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        // åˆå§‹åŒ–æ‰€æœ‰ä¸‹æ‹‰é¸å–®
        function initDropdowns() {
            populateDropdown(category1Select, Object.keys(categoriesData), 'è«‹é¸æ“‡ åˆ†é¡1');
            // åˆå§‹åŒ–æ™‚ï¼Œå¾Œé¢çš„é¸å–®éƒ½æ˜¯ç©ºçš„
            populateDropdown(category2Select, [], 'è«‹é¸æ“‡ åˆ†é¡2');
            populateDropdown(category3Select, [], 'è«‹é¸æ“‡ åˆ†é¡3');
            populateDropdown(category4Select, [], 'è«‹é¸æ“‡ åˆ†é¡4');
        }

        // ç›£è½ç¬¬ä¸€å€‹ä¸‹æ‹‰é¸å–®çš„è®Šæ›´
        category1Select.addEventListener('change', () => {
            const selectedValue = category1Select.value;
            const nextOptions = selectedValue ? Object.keys(categoriesData[selectedValue]) : [];
            populateDropdown(category2Select, nextOptions, 'è«‹é¸æ“‡ åˆ†é¡2');
            // é‡è¨­å¾Œé¢çš„é¸å–®
            populateDropdown(category3Select, [], 'è«‹é¸æ“‡ åˆ†é¡3');
            populateDropdown(category4Select, [], 'è«‹é¸æ“‡ åˆ†é¡4');
        });

        // ç›£è½ç¬¬äºŒå€‹ä¸‹æ‹‰é¸å–®çš„è®Šæ›´
        category2Select.addEventListener('change', () => {
            const selectedCategory1 = category1Select.value;
            const selectedCategory2 = category2Select.value;
            const nextOptions = (selectedCategory1 && selectedCategory2) ? Object.keys(categoriesData[selectedCategory1][selectedCategory2]) : [];
            populateDropdown(category3Select, nextOptions, 'è«‹é¸æ“‡ åˆ†é¡3');
            // é‡è¨­å¾Œé¢çš„é¸å–®
            populateDropdown(category4Select, [], 'è«‹é¸æ“‡ åˆ†é¡4');
        });

        // ç›£è½ç¬¬ä¸‰å€‹ä¸‹æ‹‰é¸å–®çš„è®Šæ›´
        category3Select.addEventListener('change', () => {
            const selectedCategory1 = category1Select.value;
            const selectedCategory2 = category2Select.value;
            const selectedCategory3 = category3Select.value;
            const nextOptions = (selectedCategory1 && selectedCategory2 && selectedCategory3) ? categoriesData[selectedCategory1][selectedCategory2][selectedCategory3] : [];
            populateDropdown(category4Select, nextOptions, 'è«‹é¸æ“‡ åˆ†é¡4');
        });
    </script>
</body>
</html>
